# Step template for sending tests to Helix.
# This template is included by build.yml to send test workloads to Helix
# machines for distributed execution.
#
# Internal vs public is determined automatically by System.TeamProject:
#   - Internal: uses HelixAccessToken from DotNet-HelixApi-Access variable group
#   - Public: uses Creator for anonymous submission
#
# Prerequisites: The DotNet-HelixApi-Access variable group must be included
# at the job level for internal builds (provides HelixApiAccessToken).

parameters:
  # Build configuration (e.g. Debug, Release)
- name: configuration
  type: string

  # Target architecture (e.g. x64, arm64)
- name: architecture
  type: string

  # Target OS group
- name: osGroup
  type: string
  default: Windows_NT
  values:
  - Windows_NT
  - Linux
  - MacOS

  # Helix queue to target
- name: helixQueues
  type: string

steps:
- ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
  - script: >
      $(Build.SourcesDirectory)\eng\common\msbuild.cmd
      $(Build.SourcesDirectory)\eng\helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=Windows_NT
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:HelixAccessToken=$(HelixApiAccessToken)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (internal)
    condition: and(succeeded(), ne(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - script: >
      $(Build.SourcesDirectory)\eng\common\msbuild.cmd
      $(Build.SourcesDirectory)\eng\helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=Windows_NT
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:Creator=$(Build.RequestedFor)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (public)
    condition: and(succeeded(), eq(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

- ${{ if eq(parameters.osGroup, 'Linux') }}:
  - script: >
      $(Build.SourcesDirectory)/eng/common/msbuild.sh
      $(Build.SourcesDirectory)/eng/helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=linux
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:HelixAccessToken=$(HelixApiAccessToken)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (internal)
    condition: and(succeeded(), ne(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - script: >
      $(Build.SourcesDirectory)/eng/common/msbuild.sh
      $(Build.SourcesDirectory)/eng/helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=linux
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:Creator=$(Build.RequestedFor)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (public)
    condition: and(succeeded(), eq(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

- ${{ if eq(parameters.osGroup, 'MacOS') }}:
  - script: >
      $(Build.SourcesDirectory)/eng/common/msbuild.sh
      $(Build.SourcesDirectory)/eng/helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=osx
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:HelixAccessToken=$(HelixApiAccessToken)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (internal)
    condition: and(succeeded(), ne(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - script: >
      $(Build.SourcesDirectory)/eng/common/msbuild.sh
      $(Build.SourcesDirectory)/eng/helix.proj
      /restore
      /p:Configuration=${{ parameters.configuration }}
      /p:TargetArchitecture=${{ parameters.architecture }}
      /p:TargetOS=osx
      /p:HelixTargetQueues=${{ parameters.helixQueues }}
      /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
      /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
      /p:Creator=$(Build.RequestedFor)
      /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
    displayName: Send Tests to Helix (public)
    condition: and(succeeded(), eq(variables['System.TeamProject'], 'public'))
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
