# Step template for sending tests to Helix.
# This template is included by build.yml to send test workloads to Helix
# machines for distributed execution.
#
# Official vs PR builds:
#   - Official (isOfficialBuild=true): uses HelixAccessToken from DotNet-HelixApi-Access variable group
#   - PR/public (isOfficialBuild=false): uses Creator for anonymous submission
#
# Prerequisites: The DotNet-HelixApi-Access variable group must be included
# at the job level for official builds (provides HelixApiAccessToken).

parameters:
  # Build configuration (e.g. Debug, Release)
- name: configuration
  type: string

  # Target architecture (e.g. x64, arm64)
- name: architecture
  type: string

  # Target OS group
- name: osGroup
  type: string
  default: Windows_NT
  values:
  - Windows_NT
  - Linux
  - MacOS

  # OS suffix (e.g. -musl for Alpine Linux)
- name: osSuffix
  type: string
  default: ''

  # Helix queue to target
- name: helixQueues
  type: string

  # Whether this is an official (non-PR, internal) build
- name: isOfficialBuild
  type: boolean
  default: false

steps:
# Official builds: use HelixAccessToken for internal queues
- ${{ if eq(parameters.isOfficialBuild, true) }}:
  - ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
    - powershell: >
        & $(Build.SourcesDirectory)\eng\common\msbuild.ps1
        $(Build.SourcesDirectory)\eng\helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=Windows_NT
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:HelixAccessToken=$(HelixApiAccessToken)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - ${{ if eq(parameters.osGroup, 'Linux') }}:
    - script: >
        $(Build.SourcesDirectory)/eng/common/msbuild.sh
        $(Build.SourcesDirectory)/eng/helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=linux
        /p:OSSuffix=${{ parameters.osSuffix }}
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:HelixAccessToken=$(HelixApiAccessToken)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - ${{ if eq(parameters.osGroup, 'MacOS') }}:
    - script: >
        $(Build.SourcesDirectory)/eng/common/msbuild.sh
        $(Build.SourcesDirectory)/eng/helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=osx
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=official/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:HelixAccessToken=$(HelixApiAccessToken)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

# PR/public builds: use Creator for anonymous submission
- ${{ else }}:
  - ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
    - powershell: >
        & $(Build.SourcesDirectory)\eng\common\msbuild.ps1
        $(Build.SourcesDirectory)\eng\helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=Windows_NT
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:Creator=$(Build.RequestedFor)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - ${{ if eq(parameters.osGroup, 'Linux') }}:
    - script: >
        $(Build.SourcesDirectory)/eng/common/msbuild.sh
        $(Build.SourcesDirectory)/eng/helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=linux
        /p:OSSuffix=${{ parameters.osSuffix }}
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:Creator=$(Build.RequestedFor)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - ${{ if eq(parameters.osGroup, 'MacOS') }}:
    - script: >
        $(Build.SourcesDirectory)/eng/common/msbuild.sh
        $(Build.SourcesDirectory)/eng/helix.proj
        /restore
        /p:Configuration=${{ parameters.configuration }}
        /p:TargetArchitecture=${{ parameters.architecture }}
        /p:TargetOS=osx
        /p:HelixTargetQueues=${{ parameters.helixQueues }}
        /p:HelixSource=pr/diagnostics/$(Build.SourceBranch)
        /p:HelixType=test/${{ parameters.configuration }}/${{ parameters.architecture }}/
        /p:Creator=$(Build.RequestedFor)
        /bl:$(Build.SourcesDirectory)/artifacts/log/${{ parameters.configuration }}/SendToHelix.binlog
      displayName: Send Tests to Helix
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)