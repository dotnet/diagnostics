<Project>

  <PropertyGroup>
    <PublishDependsOnTargets>$(PublishDependsOnTargets);CollectPackageChecksumFiles</PublishDependsOnTargets>
  </PropertyGroup>

  <ItemGroup>
    <PackageChecksumFile Include="$(ArtifactsShippingPackagesDir)**\*.sha512" IsShipping="true" />
    <PackageChecksumFile Include="$(ArtifactsNonShippingPackagesDir)**\*.sha512" IsShipping="false" />
  </ItemGroup>

  <Target Name="CollectPackageChecksumFiles">
    <!-- Calculate the blob sub path for each checksum file. Checksum files do not necessarily have
         an associated blog group, thus the sub path is optional. -->
    <ItemGroup>
      <!-- Read in blog group name -->
      <PackageChecksumFile Update="@(PackageChecksumFile)">
        <BlobSubPath>$([System.IO.File]::ReadAllText('%(RootDir)%(Directory)%(Filename).blobgroup'))/</BlobSubPath>
      </PackageChecksumFile>
    </ItemGroup>

    <ItemGroup>
      <ItemsToPushToBlobFeed Include="%(PackageChecksumFile.Identity)">
        <RelativeBlobPath>diagnostics/%(PackageChecksumFile.BlobSubPath)%(Filename)%(Extension)</RelativeBlobPath>
        <ManifestArtifactData Condition="'%(IsShipping)' != 'true'">NonShipping=true</ManifestArtifactData>
        <PublishFlatContainer>true</PublishFlatContainer>
      </ItemsToPushToBlobFeed>
    </ItemGroup>
  </Target>

</Project>