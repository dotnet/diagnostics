<Project>
  <PropertyGroup>
    <PublishingVersion>3</PublishingVersion>
  </PropertyGroup>

  <PropertyGroup>
    <BundleOutputDir>$(ArtifactsDir)bundledtools/</BundleOutputDir>
    <PublishDependsOnTargets>$(PublishDependsOnTargets);CollectBundledToolsArchives</PublishDependsOnTargets>
  </PropertyGroup>

  <ItemGroup>
    <FilesToPublishToSymbolServer Include="$(BundleOutputDir)**/*.pdb" />
    <BundledToolsArchives Include="$(BundleOutputDir)**/*.zip" />
  </ItemGroup>

  <Target Name="CollectBundledToolsArchives">
    
    <!-- To dissambiguate the blob links generated by subsequent builds
    by using a build version, preferable related to the tool being published.
    Publish.proj - which imports this file - doesn't import the files in
    Microsoft.DotNet.Arcade.SDK needed to get a version. This queries a project
    to get it; dotnet-trace is a random choice as all tools share the same version.
    Once we stabilize dotnet-monitor, we might need to start calling this target
    on every tool that needs publishing. -->
    <MSBuild Projects="$(RepoRoot)src/Tools/dotnet-trace/dotnet-trace.csproj"
        Targets="_GetPackageVersionInfo"
        SkipNonexistentProjects="false">
      <Output TaskParameter="TargetOutputs" ItemName="_ResolvedPackageVersionInfo" />
    </MSBuild>

    <PropertyGroup>
      <_PackageVersion>@(_ResolvedPackageVersionInfo->'%(PackageVersion)')</_PackageVersion>
    </PropertyGroup>

    <ItemGroup>
      <ItemsToPushToBlobFeed Include="@(BundledToolsArchives)">
        <IsShipping>true</IsShipping>
        <PublishFlatContainer>true</PublishFlatContainer>
        <RelativeBlobPath>diagnostics/bundledtools/$(_PackageVersion)/%(FileName)%(Extension)</RelativeBlobPath>
        <ManifestArtifactData>Category=OTHER</ManifestArtifactData>
      </ItemsToPushToBlobFeed>
    </ItemGroup>

  </Target>
</Project>
