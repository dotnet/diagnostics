<Project>

  <Target Name="PrepareForBundling"
          BeforeTargets="GenerateSingleFileBundle"
          AfterTargets="_ComputeFilesToBundle"
          DependsOnTargets="RemoveDupeAssemblies" />

  <!-- Workaround for https://github.com/microsoft/perfview/issues/1002 -->
  <Target Name="RemoveDupeAssemblies">
    <ItemGroup>
      <_FilesToBundle Remove="$(PkgMicrosoft_Diagnostics_Tracing_TraceEvent)\lib\netstandard1.6\Dia2Lib.dll" />
      <_FilesToBundle Remove="$(PkgMicrosoft_Diagnostics_Tracing_TraceEvent)\lib\netstandard1.6\OSExtensions.dll" />
      <_FilesToBundle Remove="$(PkgMicrosoft_Diagnostics_Tracing_TraceEvent)\lib\netstandard1.6\TraceReloggerLib.dll" />
    </ItemGroup>
  </Target>

  <!--
    Run Arcade's signing project directly. The 'eng/Signing.props' extensibility props file checks
    if '$(<StageName>)' == 'true' and points Arcade to the correct files.
  -->
  <Target Name="RunArcadeSigning">
    <PropertyGroup>
      <SignStartTime>$([System.DateTime]::UtcNow)</SignStartTime>
    </PropertyGroup>

    <!--
      Run the Arcade signing project. Carry over some specific properties for Signing.props: the
      signing project project doesn't import the heavyweight Directory.Build.props/targets.
    -->
    <MSBuild
      Projects="$(ArcadeSdkSignProject)"
      Targets="Sign"
      Properties="
        $(MSBuildProjectName)=true;
        BaseOutputRootPath=$(BaseOutputRootPath);
        CrossGenRootPath=$(CrossGenRootPath);
        ArtifactsBinDir=$(ArtifactsBinDir);
        ArtifactsPackagesDir=$(ArtifactsPackagesDir);
        TargetOS=$(TargetOS);
        TargetArchitecture=$(TargetArchitecture);
        NetCoreAppCurrent=$(NetCoreAppCurrent)" />

    <PropertyGroup>
      <SignDuration>$([System.DateTime]::UtcNow.Subtract($([System.DateTime]::Parse('$(SignStartTime)'))))</SignDuration>
    </PropertyGroup>

    <Message Importance="High" Text="$(MSBuildProjectName) -> completed in $(SignDuration)" />
  </Target>

</Project>