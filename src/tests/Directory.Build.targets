<Project>
  <Import Project="$(MSBuildThisFileDirectory)..\Directory.Build.targets"/>

  <!--
    Shared target to copy debuggee sources and aux MSBuild files to artifacts for Helix testing.
    Projects opt-in by setting CopyDebuggeeSourcesToArtifacts=true.
    Optional: Set CopyLldbPluginTests=true to also copy lldbplugin.tests.
  -->
  <Target Name="CopyDebuggeeSources" AfterTargets="Build" Condition="'$(CopyDebuggeeSourcesToArtifacts)' == 'true'">
    <PropertyGroup>
      <DebuggeesDestDir>$(ArtifactsDir)test/DebuggeeSources/$(MSBuildProjectName)/Debuggees</DebuggeesDestDir>
      <AuxMsbuildDestDir>$(ArtifactsDir)test/AuxMsbuildFiles</AuxMsbuildDestDir>
      <LldbPluginTestsDestDir>$(ArtifactsDir)test/lldbplugin.tests</LldbPluginTestsDestDir>
    </PropertyGroup>
    <ItemGroup>
      <DebuggeeSourceFiles Include="$(MSBuildProjectDirectory)/Debuggees/**/*" />
      <AuxMsbuildFiles Include="$(RepoRoot)eng/AuxMsbuildFiles/**/*" />
      <LldbPluginTestFiles Include="$(TestDir)lldbplugin.tests/**/*" Condition="'$(CopyLldbPluginTests)' == 'true'" />
    </ItemGroup>
    <Copy SourceFiles="@(DebuggeeSourceFiles)"
      DestinationFolder="$(DebuggeesDestDir)/%(RecursiveDir)"
      SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(AuxMsbuildFiles)"
      DestinationFolder="$(AuxMsbuildDestDir)/%(RecursiveDir)"
      SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(LldbPluginTestFiles)"
      DestinationFolder="$(LldbPluginTestsDestDir)/%(RecursiveDir)"
      SkipUnchangedFiles="true"
      Condition="'$(CopyLldbPluginTests)' == 'true'" />
    <Message Importance="High" Text="Copied debuggee sources to $(DebuggeesDestDir)" />
    <Message Importance="High" Text="Copied aux MSBuild files to $(AuxMsbuildDestDir)" />
    <Message Importance="High" Text="Copied lldbplugin.tests to $(LldbPluginTestsDestDir)" Condition="'$(CopyLldbPluginTests)' == 'true'" />
  </Target>

  <!--
    Build all debuggees (standard and single-file versions).
    Standard builds go to: artifacts/bin/<DebuggeeName>/<Configuration>/<TFM>/
    Single-file builds go to: artifacts/bin/<DebuggeeName>/SingleFile/<Configuration>/<TFM>/<RID>/
  -->
  <Target Name="BuildDebuggees" AfterTargets="Build"
          Condition="'$(CopyDebuggeeSourcesToArtifacts)' == 'true'">
    <ItemGroup>
      <!-- All debuggee projects for standard build -->
      <DebuggeeProjects Include="$(MSBuildProjectDirectory)/Debuggees/**/*.csproj" />
      <!-- Only executable projects for single-file publish (exclude libraries) -->
      <DebuggeeExecutableProjects Include="$(MSBuildProjectDirectory)/Debuggees/**/*.csproj"
                                   Exclude="$(MSBuildProjectDirectory)/Debuggees/**/*Dll.csproj;$(MSBuildProjectDirectory)/Debuggees/**/*Library.csproj" />
      <!-- Convert TFM list to items for batching -->
      <TargetFrameworksToPublish Include="$(SupportedSubProcessTargetFrameworks)" />
    </ItemGroup>

    <Message Importance="High" Text="Building debuggees from $(MSBuildProjectDirectory)/Debuggees" />

    <!-- Build standard versions (all projects) -->
    <Exec Command="dotnet build &quot;%(DebuggeeProjects.Identity)&quot; --configuration $(Configuration)"
          Condition="'@(DebuggeeProjects)' != ''" />

    <!-- Publish single-file versions for each TFM (only executables) -->
    <Message Importance="High" Text="Publishing single-file debuggees for TFMs: $(SupportedSubProcessTargetFrameworks)" />
    <Exec Command="dotnet publish &quot;%(DebuggeeExecutableProjects.Identity)&quot; --configuration $(Configuration) --framework %(TargetFrameworksToPublish.Identity) --runtime $(TargetRid) --self-contained true /p:PublishSingleFile=true --output &quot;$(ArtifactsDir)bin/%(DebuggeeExecutableProjects.Filename)/SingleFile/$(Configuration)/%(TargetFrameworksToPublish.Identity)/$(TargetRid)&quot;"
          Condition="'@(DebuggeeExecutableProjects)' != ''" />
  </Target>
</Project>
